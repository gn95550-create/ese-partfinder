<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESE Part Finder</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
html, body { 
  overflow-x: hidden; }
:root{--ink:#202124;--ink2:#5f6368;--bd:#dadce0;--bg:#ffffff;--surface:#f7f8f9;--brand:#1a73e8;--radius:12px;--shadow:0 1px 3px rgba(60,64,67,.18),0 4px 8px rgba(60,64,67,.12);}
*{box-sizing:border-box} body{margin:0;font-family:"Roboto","Noto Sans KR",sans-serif;background:#fff;color:var(--ink)}
.wrap{width: 100%;max-width:420px;margin:0 auto;padding-left:  calc(max(16px, env(safe-area-inset-left)) + 4px);
  padding-right: calc(max(16px, env(safe-area-inset-right)) + 4px);}

/* Home */
.home{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap: 10px;padding:32px 0; overflow: visible;}
.title{
  font-weight:900;
  font-size:36px;
  line-height:1.15;       /* 줄간격을 조금 넉넉하게 */
  padding:0 8px;          /* 글자 끝이 프레임에 닿지 않게 */
  white-space:nowrap;     /* 줄바꿈 방지 */
  overflow:visible;       /* 혹시 모를 클리핑 방지 */
  -webkit-font-smoothing: antialiased; /* iOS 가독성 */
  transform: translateZ(0);}
.tag{color:var(--ink2)}
.search-card{width:100%;display:flex;flex-direction:column;gap:14px;align-items:center}
.search-row{width:100%;max-width:360px;display:flex;align-items:center;gap:8px;border:1px solid var(--bd);border-radius:12px;background:#fff;padding:10px 10px 10px 12px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
.search-row .material-icons{font-size:22px;color:var(--ink2)}
.search-input{flex:1;border:none;outline:none;font-size:16px;background:transparent}
.clear-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:16px;border:1px solid var(--bd);background:#fff;cursor:pointer}
.clear-btn .material-icons{font-size:18px;color:var(--ink2)}
.ghost-primary{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--brand);color:var(--brand);background:#fff;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.ghost-primary .material-icons{font-size:20px}
/* ---------------- Animation ---------------- */
@keyframes slideUp {
  0% {
    transform: translateY(30px);
    opacity: 0;
  }
  100% {
    transform: translateY(0);
    opacity: 1;
  }
}

.animate-up {
  animation: slideUp 1.5s ease-out forwards;
}

/* Results */
.header-row{position:sticky;top:0;background:#fff;padding:10px 0 8px;z-index:10}
.search-row.results{max-width:none;padding:10px 10px 10px 12px}
.filter-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;background:#365a7f;color:#fff;border:none;cursor:pointer}
.filter-btn .material-icons{color:#fff}

.selected-filters{display:flex;gap:8px;flex-wrap:wrap;background:#e9f0ff;border:1px solid #d2defa;border-radius:10px;padding:8px 10px;margin-top:8px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:13px;color:#2e3a4a}
.badge .key{color:#6a7a8a}

.section{margin:12px 0}
.card{background:#fff;border:1px solid var(--bd);box-shadow:var(--shadow);border-radius:12px;padding:14px}
.item{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:14px}
.list{display:flex;flex-direction:column;gap:12px}
.code{font-weight:800;letter-spacing:.2px}
.sub{margin-top:6px;color:var(--ink2)}
.hr{height:1px;background:#eceff3;margin:12px 0}
.btn-row{display:flex;gap:10px}
.btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);border-radius:10px;padding:8px 12px;background:#fff;color:var(--ink);cursor:pointer}
.btn .material-icons{font-size:18px;color:var(--ink2)}
.copy-done{color:#0b7c0b;font-weight:600}
.loading{color:#838b96;text-align:center;margin:18px 0}
mark{background:#fff3bf;padding:0 .2em;border-radius:3px}
.hidden{display:none!important}
.pager{
  display:flex; gap:6px; justify-content:center; flex-wrap:wrap;
  margin:12px 0;
}
.page-btn{
  min-width:36px; height:36px; padding:0 10px;
  border:1px solid var(--bd); border-radius:8px; background:#fff; cursor:pointer;
}
.page-btn.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
</style>
</head>
<body>

<div class="wrap">
  <!-- Home -->
  <main id="home" class="home">
  <div class="title animate-up">ESE CO.,LTD</div>
  <div class="tag animate-up" style="animation-delay:0.1s">Everyone’s Satisfied…</div>

  <section class="search-card animate-up" style="animation-delay:0.2s">
    <div class="search-row">
      <span class="material-icons" aria-hidden="true" id="homeSearchIcon">search</span>
      <input id="qHome" class="search-input" type="search" placeholder="품번, 부품명, 규격 검색" autocomplete="off"/>
      <button id="clearHome" class="clear-btn" title="지우기">
        <span class="material-icons">close</span>
      </button>
    </div>

    <button id="openAdvanced" class="ghost-primary" type="button">
      <span class="material-icons">add</span> 고급 필터 열기
    </button>
  </section>
</main>


  <!-- Results -->
  <main id="results" class="hidden">
    <div class="header-row">
      <div class="search-row results">
        <span class="material-icons">search</span>
        <input id="qResults" class="search-input" type="search" placeholder="품번/ 품명/ 규격 입력" autocomplete="off"/>
        <button id="clearResults" class="clear-btn" title="지우기"><span class="material-icons">close</span></button>
        <button id="filterBtn" class="filter-btn" title="필터">
          <span class="material-icons">filter_list</span>
        </button>
      </div>
      <div id="selectedFilters" class="selected-filters">
        <div class="badge"><span class="key">자재:</span> SUS</div>
        <div class="badge"><span class="key">규격:</span> M6~M12</div>
        <div class="badge"><span class="key">조건:</span> AND</div>
      </div>
    </div>

    <section class="section">
      <div id="summary" class="loading hidden"></div>
      <div id="list" class="list"></div>
      <div id="pager" class="pager hidden"></div>
      <div id="loading" class="loading hidden">더 많은 항목 로딩 중…</div>
      <div id="empty" class="loading hidden">검색 결과가 없습니다.</div>
    </section>
    </main>
</div>

<!-- ✅ 스크립트는 이 '한 블록'만 남기세요 -->
<script>
const API = 'https://script.google.com/macros/s/AKfycbyaN7tAdvCjHbaVFVPhJSou-0cuaqquJ0yNkdmCVO3Y2tcxLquWkCsiyYBHKZhVCjf2/exec';
// 검색어 하이라이트
// 검색어 하이라이트 (공백 무시)
function hl(text, key){
  const raw = String(text ?? '');
  const k = String(key ?? '').replace(/\s+/g,'');   // 공백 제거
  if(!k) return raw;

  // ex) "y4" → /y\s*4/gi  (사이 공백 허용)
  const pattern = k.split('').map(ch => ch.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('\\s*');
  const re = new RegExp(pattern, 'gi');
  return raw.replace(re, m => `<mark>${m}</mark>`);
}




let currentKey = '';
let started = false;
let page = 1;
const limit = 10;
let loading = false;
let totalCount = 0;

const $ = s => document.querySelector(s);

/* 화면 전환 */
function go(state){
  if(state==='home'){
    $('#home')?.classList.remove('hidden');
    $('#results')?.classList.add('hidden');
  }else{
    $('#home')?.classList.add('hidden');
    $('#results')?.classList.remove('hidden');
  }
}

/* 결과 카드 렌더 */
function renderItems(items){
  const list = $('#list');
  list.innerHTML = '';
  const frag = document.createDocumentFragment();
  items.forEach(r=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div class="code">${hl(r.code, currentKey)}</div>
      <div class="sub">${hl(r.name, currentKey)}</div>
      <div class="sub">${hl(r.spec, currentKey)}${r.vendor ? ' · '+r.vendor : ''}</div>
      <div class="hr"></div>
      <div class="btn-row">
        <button class="btn" onclick="alert('상세보기는 추후 연결됩니다.')">
          <span class="material-icons">info</span> 상세보기
        </button>
        <button class="btn" onclick="navigator.clipboard.writeText('${(r.code||'').replace(/'/g,"\\'")}')">
          <span class="material-icons">content_copy</span> 복사
        </button>
      </div>
    `;
    frag.appendChild(el);
  });
  list.appendChild(frag);
}

/* 총 건수 표시 */
function updateSummary(){
  const sum = $('#summary');
  if (!totalCount){ sum.classList.add('hidden'); sum.textContent=''; return; }
  sum.textContent = `총 ${totalCount.toLocaleString()}건 · 페이지 ${page}`;
  sum.classList.remove('hidden');
}

/* 페이저 렌더 */
function renderPager(total){
  const pager = $('#pager');
  const pages = Math.max(1, Math.ceil(total/limit));
  if (pages <= 1){ pager.classList.add('hidden'); pager.innerHTML=''; return; }

  const maxBtns = 7;
  let start = Math.max(1, page-3);
  let end   = Math.min(pages, start+maxBtns-1);
  if (end-start+1 < maxBtns) start = Math.max(1, end-maxBtns+1);

  let html = '';
  if (page > 1) html += `<button class="page-btn" data-p="${page-1}">이전</button>`;
  for (let p=start; p<=end; p++){
    html += `<button class="page-btn ${p===page?'active':''}" data-p="${p}">${p}</button>`;
  }
  if (page < pages) html += `<button class="page-btn" data-p="${page+1}">다음</button>`;

  pager.innerHTML = html;
  pager.classList.remove('hidden');

  pager.querySelectorAll('.page-btn').forEach(btn=>{
    btn.onclick = () => {
      const goTo = parseInt(btn.dataset.p, 10) || 1;
      fetchPage({ goTo });
      window.scrollTo({top:0, behavior:'smooth'});
    };
  });
}

/* API 호출 */
async function fetchPage({goTo} = {}){
  if (!started) return;
  if (loading) return;

  if (typeof goTo === 'number') page = Math.max(1, goTo);

  $('#empty').classList.add('hidden');
  $('#loading').classList.remove('hidden');

  loading = true;
  try{
    const url = `${API}?q=${encodeURIComponent(currentKey)}&page=${page}&limit=${limit}`;
    console.log('API URL =>', url);
    const res = await fetch(url, { cache:'no-store' });
    const json = await res.json();
    const items = json.items || [];
    totalCount  = json.total || 0;

    renderItems(items);
    updateSummary();
    renderPager(totalCount);
    if (items.length === 0){ $('#empty').classList.remove('hidden'); }
  }catch(err){
    console.error(err);
    $('#empty').classList.remove('hidden');
  }finally{
    $('#loading').classList.add('hidden');
    loading = false;
  }
}

/* 이벤트 바인딩 */
document.addEventListener('DOMContentLoaded', ()=>{
  go('home');

  // 홈 → 검색 실행 (돋보기/엔터)
  const doSearchFromHome = ()=>{
  currentKey = $('#qHome').value.trim().replace(/\s+/g,'');   // ★ 공백 제거
  if (currentKey.length < 2){ alert('검색어를 2글자 이상 입력해주세요.'); return; }
  started = true; page = 1;
  $('#qResults').value = currentKey;
  go('results');
  fetchPage({ goTo: 1 });
};

  $('#homeSearchIcon')?.addEventListener('click', doSearchFromHome);
  $('#qHome')?.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearchFromHome(); });

  // 결과 화면 상단 검색(엔터)
  $('#qResults')?.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    currentKey = $('#qResults').value.trim().replace(/\s+/g,'');  // ★ 공백 제거
    if (currentKey.length < 2){ alert('검색어를 2글자 이상 입력해주세요.'); return; }
    started = true; page = 1;
    fetchPage({ goTo: 1 });
  }
});

  // 지우기
  $('#clearHome')?.addEventListener('click', ()=>{ $('#qHome').value=''; $('#qHome').focus(); });
  $('#clearResults')?.addEventListener('click', ()=>{
    $('#qResults').value=''; $('#qResults').focus();
    currentKey=''; started=false; page=1; totalCount=0;
    $('#list').innerHTML='';
    $('#summary').classList.add('hidden');
    $('#pager').classList.add('hidden');
    $('#empty').classList.add('hidden');
  });

  // 필터 안내
  $('#filterBtn')?.addEventListener('click', ()=> alert('필터 패널은 추후 연결됩니다.'));
  $('#openAdvanced')?.addEventListener('click', ()=> alert('필터 패널은 추후 연결됩니다.'));

  // 초기 포커스
  $('#qHome')?.focus();
  
});
</script>
</body>
</html>